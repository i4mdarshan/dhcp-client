<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DHCPClient</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap");
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
      <h1 class="text-2xl font-bold text-gray-800 mb-1">DHCP Client</h1>
      <p class="text-gray-500 mb-3">
        Request an IP address from your local DHCP server.
      </p>
      <div id="status" class="mb-2 p-2 bg-gray-50 rounded-md hidden">
        <p class="font-small"></p>
      </div>

      <div class="mb-4">
        <label for="macAddress" class="block text-sm font-medium text-gray-700"
          >Client MAC Address</label
        >
        <div class="flex items-center my-2">
          <input
            type="text"
            id="macAddress"
            class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md py-2"
            placeholder="e.g., aa:bb:cc:dd:ee:ff"
          />
          <button
            id="detectMacBtn"
            class="ml-2 px-2 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50"
          >
            Detect
          </button>
        </div>
      </div>

      <div class="space-y-4">
            <button id="requestIpBtn" class="w-full bg-gray-800 text-white py-2 px-4 rounded-md hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200">
                Request IP Address
            </button>
            <button id="releaseIpBtn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200 hidden">
                Release IP Address
            </button>
        </div>
    </div>

    <script>
      const requestBtn = document.getElementById("requestIpBtn");
      const releaseBtn = document.getElementById('releaseIpBtn');
      const detectMacBtn = document.getElementById("detectMacBtn");
      const macInput = document.getElementById("macAddress");
      const statusDiv = document.getElementById("status");
      const statusText = statusDiv.querySelector("p");
      let pollingInterval;
      let leasedIpInfo = {};

      // set status
      function setStatus(message, type) {
        statusDiv.classList.remove("hidden");
        statusText.innerHTML = message;
        if (type === "info") {
          statusDiv.className = "mb-2 p-2 bg-blue-100 text-blue-800 rounded-md";
        } else if (type === "success") {
          statusDiv.className =
            "mb-2 p-2 bg-green-100 text-green-800 rounded-md";
        } else if (type === "error") {
          statusDiv.className = "mb-2 p-2 bg-red-100 text-red-800 rounded-md";
        }
      }

      // handle detect button
      detectMacBtn.addEventListener("click", () => {
        statusText.textContent = "Detecting MAC address...";
        statusDiv.classList.remove("hidden");
        statusDiv.className = "mb-2 p-2 bg-blue-50 rounded-md";

        fetch("/get-mac-address")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              macInput.value = data.mac_address;
              setStatus("MAC Address detected!", "success");
            } else {
              setStatus(`Error detecting MAC: ${data.error}`, "error");
            }
          })
          .catch((err) => {
            setStatus("An error occured while detecting.", "error");
          });
      });

      // poll status to display in real-time
      function pollStatus(taskId) {
        pollingInterval = setInterval(() => {
          fetch(`/status/${taskId}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "SUCCESS") {
                clearInterval(pollingInterval);
                leasedIpInfo = { ip_address: data.assigned_ip, server_id: data.server_id };
                setStatus(
                  `<strong>Success!</strong> Assigned IP: <span class="font-mono">${data.assigned_ip}</span>`,
                  "success"
                );
                requestBtn.disabled = false;
                requestBtn.textContent = "Request New IP Address";
                releaseBtn.classList.remove('hidden');
              } else if (data.status.startsWith("FAILED")) {
                clearInterval(pollingInterval);
                setStatus(`<strong>Failed:</strong> ${data.status}`, "error");
                requestBtn.disabled = false;
                requestBtn.textContent = "Request IP Address";
              } else {
                setStatus(data.status, "info");
              }
            });
        }, 1000); // Poll every 1 second
      }

      // handle request IP address button
      requestBtn.addEventListener("click", () => {
        const macAddress = macInput.value;
        if (!macAddress) {
          alert("Please enter or detect a MAC address.");
          return;
        }

        if (pollingInterval) clearInterval(pollingInterval);

        requestBtn.disabled = true;
        releaseBtn.classList.add('hidden');
        requestBtn.textContent = "Starting...";
        setStatus("Initializing...", "info");

        fetch("/start-dhcp", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ mac_address: macAddress }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              pollStatus(data.task_id);
            } else {
              setStatus(`<strong>Error:</strong> ${data.message}`, "error");
              requestBtn.disabled = false;
              requestBtn.textContent = "Request IP Address";
            }
          })
          .catch((error) => {
            setStatus(
              "<strong>Error:</strong> An unexpected error occurred. Check the console.",
              "error"
            );
            requestBtn.disabled = false;
            requestBtn.textContent = "Request IP Address";
          })
          .finally(() => {
            requestBtn.disabled = false;
            requestBtn.textContent = "Request IP Address";
          });
      });

      // handle releaseIp button
      releaseBtn.addEventListener('click', () => {
            if (!leasedIpInfo.ip_address) {
                alert('No leased IP to release.');
                return;
            }
            
            setStatus(`Releasing IP ${leasedIpInfo.ip_address}...`, 'info');
            releaseBtn.disabled = true;

            fetch('/release-ip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mac_address: macInput.value,
                    ip_address: leasedIpInfo.ip_address,
                    server_id: leasedIpInfo.server_id
                })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    setStatus(`IP ${leasedIpInfo.ip_address} released successfully.`, 'success');
                    leasedIpInfo = {};
                    releaseBtn.classList.add('hidden');
                } else {
                    setStatus(`<strong>Error:</strong> ${data.message}`, 'error');
                }
            }).finally(() => {
                releaseBtn.disabled = false;
            });
        });

    </script>
  </body>
</html>
